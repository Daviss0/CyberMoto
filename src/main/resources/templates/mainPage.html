<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>main page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        footer { color: white; margin-top: 50px }
        footer a { color: white; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img th:src="@{/cybermoto-logo.png}" alt="logo-cybermoto" width="60" height="60" class="me-2" style="margin-left: 40px">
        </a>

        <!-- Toggle para mobile -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
                aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Itens da navbar -->
        <div class="collapse navbar-collapse justify-content-end" id="navbarMenu">
            <ul class="navbar-nav mb-2 mb-lg-0">

                <!-- Quando logado -->
                <li class="nav-item dropdown" th:if="${client != null}">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i>
                        <span th:text="${client.name}">Usuário</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" th:href="@{/client/account}">
                                <i class="bi bi-person-lines-fill"></i> Minha Conta
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" th:href="@{/meus-pedidos}">
                                <i class="bi bi-card-list"></i> Meus Pedidos
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" th:href="@{/client/mainPage}">
                                <i class="bi bi-house"></i> Home
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/client/logout}" method="post" style="display: inline;">
                                <button type="submit" class="dropdown-item" style="border: none; background: none;">
                                    <i class="bi bi-box-arrow-right"></i> Sair
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>

                <!-- Quando NÃO logado -->
                <li class="nav-item" th:if="${client == null}">
                    <a class="nav-link btn btn-primary px-3" th:href="@{/client/login-client}">
                        <i class="bi bi-box-arrow-in-right"></i> Entrar / Cadastrar
                    </a>
                </li>

            </ul>
        </div>
    </div>
</nav>


<div class="container mt-5 pt-5">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        <div class="col" th:each="product : ${products}">
            <div class="card h-100 text-center">

                <!-- Imagem do card (com fallback) -->
                <div class="ratio ratio-4x3">
                    <img th:src="${product.mainImage != null} ? @{/uploads/products/{f}(f=${product.mainImage.filename})} : @{/uploads/products/placeholder.jpg}"
                         class="w-100 h-100 object-fit-cover"
                         alt="imagem do produto">
                </div>

                <div class="card-body">
                    <h5 class="card-title" th:text="${product.productName}">Nome do Produto</h5>
                    <p class="card-text text-success fw-bold"
                       th:text="'R$ ' + ${#numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')}">Preço</p>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary"
                                th:onclick="'adicionarAoCarrinho(' + ${product.id} + ')'">
                            Adicionar ao Carrinho
                        </button>

                        <!-- Botão Detalhes (sem streams/lambdas) -->
                        <button class="btn btn-outline-secondary"
                                th:attr="data-id=${product.id},
                                         data-nome=${product.productName},
                                         data-marca=${product.brand},
                                         data-descricao=${product.description},
                                         data-preco=${product.price},
                                         data-quantidade=${product.quantity},
                                         data-rating=${product.rating}"
                                onclick="abrirModal(this)">
                            Detalhes
                        </button>
                    </div>
                </div>

                <!-- Lista oculta com as URLs das imagens deste produto -->
                <ul class="d-none images-list">
                    <li th:each="img : ${product.images}"
                        th:text="@{'/uploads/products/' + ${img.filename}}">/uploads/products/example.jpg</li>
                </ul>

            </div>
        </div>
    </div>
</div>

<footer style="background-color: #2a2a2a; padding: 20px 0; font-family: Arial, sans-serif; color: white;">
    <table width="100%" border="0" cellspacing="0" cellpadding="15" style="max-width: 1200px; margin: 0 auto; border-collapse: collapse;">
        <tr>
            <td width="33%" style="vertical-align: top; border-right: 1px solid #444; padding-right: 20px;">
                <div style="font-weight: bold; margin-bottom: 8px; font-size: 18px;">Sobre a CyberMoto</div>
                <div style="color: #ccc; font-size: 14px; line-height: 1.5;">
                    Sua loja de acessórios e peças de moto confiável com os melhores preços e produtos de qualidade.
                </div>
            </td>
            <td width="33%" style="vertical-align: top; border-right: 1px solid #444; padding: 0 20px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 8px; font-size: 18px;">Links Úteis</div>
                <div style="color: #ccc; font-size: 14px; line-height: 1.8;">
                    <div><a th:href="@{/contato}">Contato</a></div>
                    <div><a th:href="@{/politica-privacidade}">Política de Privacidade</a></div>
                    <div><a th:href="@{/termos-uso}">Termos de Uso</a></div>
                </div>
            </td>
            <td width="33%" style="vertical-align: top; padding-left: 20px;">
                <div style="font-weight: bold; margin-bottom: 8px; font-size: 18px;">Redes Sociais</div>
                <div style="color: #ccc; font-size: 24px;">
                    <a href="https://www.facebook.com/senacsaopaulo" target="_blank" style="color: #ccc; text-decoration: none; margin-right: 15px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg>
                    </a>
                    <a href="https://x.com/senacsaopaulo" target="_blank" style="color: #ccc; text-decoration: none; margin-right: 15px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>
                    </a>
                    <a href="https://www.instagram.com/senacsaopaulo/" target="_blank" style="color: #ccc; text-decoration: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg>
                    </a>
                </div>
            </td>
        </tr>
    </table>
</footer>

<!-- Modal Detalhes do Produto -->
<div class="modal fade" id="modalDetalhesProduto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalProdutoTitulo">Detalhes do Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <div class="row g-4">

                    <!-- Coluna com imagens (Carousel) -->
                    <div class="col-md-6">
                        <div id="modalProdutoCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner" id="modalProdutoCarouselInner"><!-- injetado via JS --></div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#modalProdutoCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Anterior</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#modalProdutoCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Próximo</span>
                            </button>
                        </div>
                    </div>

                    <!-- Coluna com informações -->
                    <div class="col-md-6">
                        <h4 id="modalProdutoNome" class="mb-1">Nome do Produto</h4>
                        <div class="text-muted mb-2">Marca: <span id="modalProdutoMarca">—</span></div>

                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div id="modalProdutoEstrelas" class="d-inline-flex align-items-center"></div>
                            <small class="text-muted" id="modalProdutoRatingTexto"></small>
                        </div>

                        <h6>Descrição</h6>
                        <p id="modalProdutoDescricao">—</p>

                        <h6>Preço</h6>
                        <div id="modalProdutoPreco" class="fw-bold text-success fs-5 mb-2">—</div>

                        <h6>Quantidade em estoque</h6>
                        <div id="modalProdutoQuantidade" class="fw-bold mb-3">—</div>

                        <button id="modalBtnAdicionar" type="button" class="btn btn-primary">Adicionar ao Carrinho</button>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>

        </div>
    </div>
</div>

<script>
    /* Estrelas */
    const STAR_FULL = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.401 8.168L12 18.896l-7.335 3.869 1.401-8.168L.132 9.21l8.2-1.192L12 .587z"/></svg>`;
    const STAR_EMPTY = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" stroke-width="1.5"/></svg>`;
    const STAR_HALF = `<svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="half"><stop offset="50%"/><stop offset="50%" stop-color="transparent"/></linearGradient></defs><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.401 8.168L12 18.896l-7.335 3.869 1.401-8.168L.132 9.21l8.2-1.192L12 .587z" fill="currentColor"/><rect x="12" y="0" width="12" height="24" fill="white"></rect><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.401 8.168L12 18.896l-7.335 3.869 1.401-8.168L.132 9.21l8.2-1.192L12 .587z" fill="url(#half)"/></svg>`;

    function renderStars(container, rating) {
        container.innerHTML = "";
        const r = Math.round((parseFloat(rating)||0) * 2) / 2;
        const full = Math.floor(r);
        const hasHalf = r - full >= 0.5;
        for (let i = 0; i < full; i++) container.insertAdjacentHTML('beforeend', STAR_FULL);
        if (hasHalf) container.insertAdjacentHTML('beforeend', STAR_HALF);
        for (let i = (hasHalf ? full + 1 : full); i < 5; i++) container.insertAdjacentHTML('beforeend', STAR_EMPTY);
    }

    function formatPrice(value) {
        const num = typeof value === 'number' ? value : parseFloat(value);
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    /* Abre e preenche o modal */
    function abrirModal(btn) {
        const card = btn.closest('.card');
        const dataset = btn.dataset;

        // textos
        document.getElementById('modalProdutoTitulo').textContent = 'Detalhes do Produto';
        document.getElementById('modalProdutoNome').textContent = dataset.nome || '—';
        document.getElementById('modalProdutoMarca').textContent = dataset.marca || '—';
        document.getElementById('modalProdutoDescricao').textContent = dataset.descricao || '—';
        document.getElementById('modalProdutoPreco').textContent = formatPrice(dataset.preco || 0);
        document.getElementById('modalProdutoQuantidade').textContent = dataset.quantidade ?? '—';

        // estrelas
        const rating = parseFloat(dataset.rating || '0');
        renderStars(document.getElementById('modalProdutoEstrelas'), rating);
        document.getElementById('modalProdutoRatingTexto').textContent = `(${rating.toFixed(1)} de 5)`;

        // botão adicionar
        const id = dataset.id;
        document.getElementById('modalBtnAdicionar').onclick = function () {
            if (typeof adicionarAoCarrinho === 'function') adicionarAoCarrinho(id);
        };

        // Monta o carousel pelas URLs na lista oculta
        const carouselInner = document.getElementById('modalProdutoCarouselInner');
        carouselInner.innerHTML = '';

        const urls = Array.from(card.querySelectorAll('.images-list li')).map(li => li.textContent.trim()).filter(Boolean);

        if (urls.length === 0) {
            urls.push('/uploads/products/placeholder.jpg');
        }

        urls.forEach((src, index) => {
            const item = document.createElement('div');
            item.className = 'carousel-item' + (index === 0 ? ' active' : '');
            item.innerHTML = `<img src="${src}" class="d-block w-100 object-fit-contain" style="max-height:400px;" alt="Imagem do produto">`;
            carouselInner.appendChild(item);
        });

        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalDetalhesProduto')).show();
    }
</script>

</body>
</html>
